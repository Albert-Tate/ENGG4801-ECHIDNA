\documentclass[12pt,openany,a4paper]{book}
\usepackage{graphics}	% if you want encapsulated PS figures.
\usepackage{titlesec}
\usepackage{textcomp}
\usepackage{float}
\usepackage{adjustbox}
\usepackage{graphicx}
\usepackage{wrapfig}
\usepackage{hyperref}
\usepackage{listings}
\usepackage[table]{xcolor}
\usepackage[final]{pdfpages}

\titleformat{\chapter}{\normalfont\huge\bf}{\thechapter.}{20pt}{\huge}

\lstdefinestyle{customc}{
	belowcaptionskip=1\baselineskip,
	breaklines=true,
	numbers=left,
	tabsize=4,
	xleftmargin=\parindent,
	language=C,
	showstringspaces=false,
	basicstyle=\ttfamily\scriptsize,
	keywordstyle=\bfseries\color{green!40!black},
	commentstyle=\itshape\color{purple!40!black},
	identifierstyle=\color{blue},
	stringstyle=\color{orange},
}

\lstset{escapechar=@,style=customc}
% If you use a macro file called macros.tex :
% \input{macros}
% Note: The present document has its macros built in.

% Number subsections but not subsubsections:
\setcounter{secnumdepth}{2}
% Show subsections but not subsubsections in table of contents:
\setcounter{tocdepth}{2}

\pagestyle{headings}		% Chapter on left page, Section on right.
\raggedbottom

\setlength{\topmargin}		{-5mm}  %  25-5 = 20mm
\setlength{\oddsidemargin}	{10mm}  % rhs page inner margin = 25+10mm
\setlength{\evensidemargin}	{0mm}   % lhs page outer margin = 25mm
\setlength{\textwidth}		{150mm} % 35 + 150 + 25 = 210mm
\setlength{\textheight}		{240mm} % 

\renewcommand{\baselinestretch}{1.2}	% Looks like 1.5 spacing.

% Stop figure/tables smaller than 3/4 page from appearing alone on a page:
\renewcommand{\textfraction}{0.25}
\renewcommand{\topfraction}{0.75}
\renewcommand{\bottomfraction}{0.75}
\renewcommand{\floatpagefraction}{0.75}

% THEOREM-LIKE ENVIRONMENTS:
\newtheorem{defn}	{Definition}	% cf. \dfn for cross-referencing
\newtheorem{theorem}	{Theorem}	% cf. \thrm for cross-referencing
\newtheorem{lemma}	{Lemma}		% cf. \lem for cross-referencing

% AIDS TO CROSS-REFERENCING (All take a label as argument):
\newcommand{\eref}[1] {(\ref{#1})}		% (...)
\newcommand{\eq}[1]   {Eq.\,(\ref{#1})}		% Eq.~(...)
\newcommand{\eqs}[2]  {Eqs.~(\ref{#1}) and~(\ref{#2})}
\newcommand{\dfn}[1]  {Definition~\ref{#1}}	% Definition~...
\newcommand{\thrm}[1] {Theorem~\ref{#1}}	% Theorem~...
\newcommand{\lem}[1]  {Lemma~\ref{#1}}		% Lemma~...
\newcommand{\fig}[1]  {Fig.\,\ref{#1}}		% Fig.~...
\newcommand{\tab}[1]  {Table~\ref{#1}}		% Table~...
\newcommand{\chap}[1] {Chapter~\ref{#1}}	% Chapter~...
\newcommand{\secn}[1] {Section~\ref{#1}}	% Section~...
\newcommand{\ssec}[1] {Subsection~\ref{#1}}	% Subsection~...

% AIDS TO FORMATTING:
\newcommand{\teq}[1]	{\mbox{$#1$}}	% in-Text EQuation (unbreakable)
\newcommand{\qed}	{\hspace*{\fill}$\bullet$}	% end of proof

% MATHEMATICAL TEMPLATES:
% Text or math mode:
\newcommand{\half}	{\ensuremath{\frac{1}{2}}}	% one-half
\newcommand{\halftxt}	{\mbox{$\frac{1}{2}$}}	  	% one-half, small
% Math mode only:
% N.B. Parentheses are ROUND; brackets are SQUARE!
\newcommand{\oneon}[1]	{\frac{1}{#1}}		  % reciprocal
\newcommand{\pow}[2]	{\left({#1}\right)^{#2}}  % Parenthesized pOWer
\newcommand{\bow}[2]	{\left[{#1}\right]^{#2}}  % Bracketed pOWer
\newcommand{\evalat}[2]	{\left.{#1}\right|_{#2}}  % EVALuated AT with bar
\newcommand{\bevalat}[2]{\left[{#1}\right]_{#2}}  % Bracketed EVALuated AT
% Total derivatives:
\newcommand{\sdd}[2]	{\frac{d{#1}}{d{#2}}}		    % Short
\newcommand{\sqdd}[2]	{\frac{d^2{#1}}{d{#2}^2}}	    % 2nd ("SQuared")
\newcommand{\ldd}[2]	{\frac{d}{d{#1}}\left({#2}\right)}  % Long paren'ed
\newcommand{\bdd}[2]	{\frac{d}{d{#2}}\left[{#2}\right]}  % long Bracketed
% Partial derivatives (same sequence as for total derivatives):
\newcommand{\sdada}[2]	{\frac{\partial {#1}}{\partial {#2}}}
\newcommand{\sqdada}[2]	{\frac{\partial ^{2}{#1}}{\partial {#2}^{2}}}
\newcommand{\ldada}[2]	{\frac{\partial}{\partial {#1}}\left({#2}\right)}
\newcommand{\bdada}[2]	{\frac{\partial}{\partial {#1}}\left[{#2}\right]}
\newcommand{\da}	{\partial}

% ORDINAL NUMBERS:
\newcommand{\ith}	{\ensuremath{i^{\rm th}}}
\newcommand{\jth}	{\ensuremath{j^{\rm th}}}
\newcommand{\kth}	{\ensuremath{k^{\rm th}}}
\newcommand{\lth}	{\ensuremath{l^{\rm th}}}
\newcommand{\mth}	{\ensuremath{m^{\rm th}}}
\newcommand{\nth}	{\ensuremath{n^{\rm th}}}

% SINUSOIDAL TIME AND SPACE-DEPENDENCY FACTORS:
\newcommand{\ejot}	{\ensuremath{e^{j\omega t}}}
\newcommand{\emjot}	{\ensuremath{e^{-j\omega t}}}

% UNITS (TEXT OR MATH MODE, WITH LEADING PADDING SPACE IF APPLICABLE):
% NB: These have not been tested since being modified for LaTeX2e.
\newcommand{\pack}	{\hspace{-0.08em}}
\newcommand{\Pack}	{\hspace{-0.12em}}
\newcommand{\mA}	{\ensuremath{\rm\,m\pack A}}
\newcommand{\dB}	{\ensuremath{\rm\,d\pack B}}
\newcommand{\dBm}	{\ensuremath{\rm\,d\pack B\pack m}}
\newcommand{\dBW}	{\ensuremath{\rm\,d\pack B\Pack W}}
\newcommand{\uF}	{\ensuremath{\rm\,\mu\pack F}}
\newcommand{\pF}	{\ensuremath{\rm\,p\pack F}}
\newcommand{\nF}	{\ensuremath{\rm\,n\pack F}}
\newcommand{\uH}	{\ensuremath{\rm\,\mu\pack H}}
\newcommand{\mH}	{\ensuremath{\rm\,m\pack H}}
\newcommand{\Hz}	{\ensuremath{\rm\,H\pack z}}
\newcommand{\kHz}	{\ensuremath{\rm\,k\pack H\pack z}}
\newcommand{\MHz}	{\ensuremath{\rm\,M\pack H\pack z}}
\newcommand{\GHz}	{\ensuremath{\rm\,G\pack H\pack z}}
\newcommand{\J}		{\ensuremath{\rm\,J}}
\newcommand{\kg}	{\ensuremath{\rm\,k\pack g}}
\newcommand{\K}		{\ensuremath{\rm\,K}}
\newcommand{\m}		{\ensuremath{\rm\,m}}
\newcommand{\cm}	{\ensuremath{\rm\,cm}}
\newcommand{\km}	{\ensuremath{\rm\,k\pack m}}
\newcommand{\mm}	{\ensuremath{\rm\,m\pack m}}
\newcommand{\nm}	{\ensuremath{\rm\,n\pack m}}
\newcommand{\um}	{\ensuremath{\rm\,\mu m}}
\newcommand{\Np}	{\ensuremath{\rm\,N\pack p}}
\newcommand{\s}		{\ensuremath{\rm\,s}}
\newcommand{\ms}	{\ensuremath{\rm\,m\pack s}}
\newcommand{\us}	{\ensuremath{\rm\,\mu s}}
\newcommand{\V}		{\ensuremath{\rm\,V}}
\newcommand{\mV}	{\ensuremath{\rm\,m\Pack V}}
\newcommand{\W}		{\ensuremath{\rm\,W}}
\newcommand{\mW}	{\ensuremath{\rm\,m\Pack W}}
\newcommand{\ohm}	{\ensuremath{\rm\,\Omega}}
\newcommand{\kohm}	{\ensuremath{\rm\,k\Omega}}
\newcommand{\Mohm}	{\ensuremath{\rm\,M\Omega}}
\newcommand{\degs}	{\ensuremath{\rm^{\circ}}}

% LaTeX run-time type-in command:
%
% \typein{Enter \protect\includeonly{...} command (or just type RETURN):}
%
% Uncommenting this command makes LaTeX prompt you for the \includeonly
% list.  At the prompt
%
%	\@typein=
%
% you type
%
%	\includeonly{chap1,chap2}
%
% to include the files chap1.tex and chap2.tex and omit any others.
% To include every \include file, just hit RETURN.
% If you are running LaTeX from xtexsh, you may need to click the mouse
% in the LaTeX window to position the cursor at the \@typein prompt.

\begin{document}

\frontmatter
% By default, frontmatter has Roman page-numbering (i,ii,...).

\begin{titlepage}
\renewcommand{\baselinestretch}{1.0}
\begin{center}
\vspace*{35mm}
\Huge\bf
	%Low Power Sensor Board for Tracking Lightweight Animals \\
	$\mu$Tracker - Ultra Compact Sensing Platform \\
\vspace{20mm}
\large\sl
		by\\
		Albert Tate
		\medskip\\
\rm
		School of Information Technology and Electrical Engineering,\\
		The University of Queensland.\\
\vspace{30mm}
		Submitted for the degree of\\
		Bachelor of Engineering
		\smallskip\\
\normalsize
		in the field of Electrical and Computer Engineering
		\medskip\\
\large
		November 2015		
\end{center}
\end{titlepage}

\cleardoublepage

\begin{flushright}
	\bf Albert Tate\\ \normalfont
	42910444\\
	67 Swan Street\\
	Gordon Park\\
	QLD 4031\\
	\medskip
\end{flushright}
\begin{flushleft}
  Prof Paul Strooper\\
  Head of School\\
  School of Information Technology and Electrical Engineering\\
  The University of Queensland\\
  St Lucia, Q 4072\\
  \bigskip\bigskip
  Dear Professor Strooper,
\end{flushleft}

In accordance with the requirements of the degree of Bachelor of
Engineering in the School of Information Technology and Electrical Engineering,
I present the following thesis entitled 
\begin{center}
	\emph{``$\mu$Tracker - Ultra Compact Sensing Platform''}
\end{center}  This work was performed under the supervision of Dr Philip Terrill.
I declare that the work submitted in this thesis is my own, except as
acknowledged in the text and footnotes, and has not been previously
submitted for a degree at The University of Queensland or any other
institution.

\begin{flushright}
	Yours sincerely,\\
	\medskip
	\makebox[1.0in]{\hrulefill}\\
	\medskip
	Albert Tate.
\end{flushright}

\cleardoublepage

\chapter{Acknowledgments}

%Acknowledge your supervisor, preferably with a few short and specific
%statements about his/her contribution to the content and direction of
%the project.  If you collaborated with another student, acknowledge
%your partner's contribution, including any parts of the thesis of
%which s/he was the principal author or co-author; this information can
%be duplicated in footnotes to the chapters or sections to which your
%partner has contributed.  Briefly describe any assistance that you
%received from technical or administrative staff.  Support of family
%and friends may also be acknowledged, but avoid sentimentality---or
%hide it in the dedication.
%Acknowledge UWA, Craig Freakley for BeeBoard

\cleardoublepage

\chapter{Abstract}

% Yeah really need to like actually redo this.
needs to be rewritten\\

%The use of biologging for remote sensing of animal behavior has had a long history and many novel applications \cite{Coudert05}. A key datatype in recent years has been tri-axial accelerometry \cite{Ran12,Shepard08} which can be used to accurately discern between different movement types and postures in animals or humans \cite{Lamprecht14,Terrill13}. Despite the widespread use of biologging for animal research, most solutions are either very heavy \cite{Marshall07} or, when light, rely on existing infrastructure in the environment like radio base stations \cite{Jurdak13} or cell-phone towers \cite{Bennett11}. In this report a project is proposed to redesign an existing board, the BEE-UTE Board \cite{Freakley13} to be smaller, more efficient and have a longer operating lifetime. This will allow the board to be used on a larger variety of animals and allow for greater time between recaptures of the animal for data retrieval which will have both monetary benefits and less impact on the welfare of the animal. The proposed project will be able to measure light intensity, tri-axial accelerometry, temperature, air pressure and GPS position in a package with a total weight of less than 50 grams including battery and a board size of less than 2.5cm by 2.5cm which will operate at 100Hz sampling rate with selective GPS readings for at least 14 days. The GPS readings will activate when significant activity is measured, calculated by a simple moving average (SMA) on the accelerometer data. The low power functionality will be achieved by a novel power control scheme and the use of power efficient volatile memory, SRAM, to allow much larger bulk writes to non-volatile memory (microSD card).

\tableofcontents

\listoffigures
\addcontentsline{toc}{chapter}{List of Figures}

\listoftables
\addcontentsline{toc}{chapter}{List of Tables}

% If file los.tex begins with ``\chapter{List of Symbols}'':
% \include{los}

\cleardoublepage

\mainmatter
% By default, mainmatter has Arabic page-numbering (1,2,...).


% Chapters may be \include files, each beginning with a line like
%
%	\chapter{Title of chapter}
%
% e.g. if two chapter files were called intro.tex and theory.tex,
% we would say
%
%	\include{intro}
%	\include{theory}

\chapter{Introduction}
Echidnas are small native animals of Australia and New Guinea. The echidna is from the order monotremata meaning, in non technical terms, that it is a mammal that lays eggs. Monotremes are a unique order of animals with only five extant species and very little is known about their physiological response to environment stressors.\\ 

Generally speaking, echidnas struggle with external temperatures greater than about 35 degrees celsius \cite{Brice02}. This suggested that their thermoregulation came from an external source much like cold blooded animals. However recent studies have suggested that this might not be the case and now the general assumption is that echidnas employ a combination of both strategies, behavioural and physiological, to manage their body temperature \cite{Brice02}. This has lead to a significant research interest in being able to track these animals in the wild.\\

Due to strict ethics regulations mandating extremely low weights in biologging electronics \cite{Mamm87}, current existing biologging devices find themselves regularly unsuitable for such an application, usually limited by an extremely short battery life. Modern technologies and methods may have the ability to facilitate significantly smaller, lighter, robust and more power efficient biologging device to be created. \\

These biologging devices are designed in order to track the behaviour of the animal in its natural habitat. Things like movement, temperature, physical location and current light intensity are all commonly used on such platforms. Some platforms, such as the CritterCam \cite{Marshall07}, also record more advanced parameters of the environment like audio and video. \\

These biologging devices would not be limited to just echidnas however; there are a significant number of animals in the same weight class that are poorly understood. Such a device would also allow studies of things such as predator-prey dynamics in the wild, tracking migratory animals in extreme environments and observing crowd dynamics in unfenced livestock. \\

In light of this scenario, there is a significant research potential for such a device being developed; a tracker with a weight of less than 100 grams with operating lifetimes measured in days, perhaps weeks, rather than hours.

\chapter{Background}
	\section{Echidna Physiology \& Behaivour} \label{sec:echidna}
	Echidna thermoregulation is poorly understood. There is no complete consensus on how it is done \cite{Brice02} but current studies suggest it is a combination of behaivoural patterns, like laying in the sun as a cold blooded animal would do, and physiological mechanisms, like any warm blooded creature.\\ 
	
	Their internal body temperature has been measured from as high as 35\textdegree C and as low as 5\textdegree C during hibernation. The echidna will usually seek shelter in hot conditions and is not known to sweat or pant. During autumn and winter, the echidna will generally go into a hibernative state, severely reducing activity. While the echidna are active however, they very seldom have interactions with other creatures. They are generally considered to be solitary creatures. \\
	
	Despite their solitary lifestyle, when they are not in hibernation they can cover significant distances within a single day, swim about as well as most mammals and will dig into ant and termite nests for food and nest in small burrows and hollowed out logs. \\
	
	Despite the diet of ants and other insects, the echidna can grow up to 6kg in weight for males and around 4.5kg for females. The echidna is only about 30-45cm long in the body which makes it a relatively dense creature. \\

	The echidna is found all around Australia and in the southern mountains of New Guinea and as such, it has managed to survive in a range of climates. It has been found in both snowy regions and dry deserts. They do not have fixed shelter and tend to wander about, which makes population studies difficult. \\
	
	Given this information, in order to properly understand what the echidna is doing at any given time a number of parameters must be sensed. In order to detect behaviours that could increase their body temperature, like moving around and basking in the sun, it is necessary to have some form of movement sensor and a light sensor. To understand if echidnas have these reactions to increased body temperature, environment temperature or both, it will be necessary to have an external temperature sensor and a sub dermal one. The selection, specification and implementation of the sub dermal temperature sensor is however out of the scope of this project.
	%Due to a lack of suitable biologging platforms, existing studies have generally been done outside of the native habitat, which may have limited the accuracy of any results.
	
	\section{Product Specification} \label{sec:spec}
	In light of this knowledge from the previous section, it is now possible to know what the biologging device should do and why. The key performance characteristic will be operational lifetime as there is an existing product \cite{Freakley13} that otherwise meets the specifications, but only lasts 40 hours in the field. \\
	
	The device needs to be extremely light to comply with ethics regulations \cite{Mamm87} usually being around 5\% of the body weight of the creature. In addition to this it must be extremely robust, it needs to handle the large temperature swings found in deserts, the enclosure must be waterproof and handle most low speed impacts. \\
	
	In order to properly track any behaviour the echidna may exhibit in order to change its body temperature, the enclosure must be transparent, to allow for light sensing. Rudimentary movement sensing also needs to be used. The device should be able to track absolute position, where appropriate, using a GPS module. Tracking internal temperature can not be reasonably done with a board solution and will be done with another device, the specification and selection of which is out of the scope of this design. However the environmental temperature will be sensed. \\
	
	Due to the hibernative nature of the echidna, the onboard firmware should have some rudimentary analysis on the data to allow it to change sampling rates depending on the level of activity, to best extend the battery life. \\
	
	Table \ref{tab:SPEC} quantitatively specifies some of the  other requirements of the design: \\
	\begin{table}[H]
		\centering
		\begin{adjustbox}{max width=\textwidth}
			\rowcolors{2}{white}{lightgray}
			\begin{tabular}{c | c }
				Description & Specification\\
				\hline
				Max system weight & 50g \\
				Max board size & 40mm x 40mm  \\
				Operational lifetime & 7 days \\
				Max material cost & \$150 AUD \\
				Robustness & IP67 \\
				Min storage space & 1GB
			\end{tabular}
		\end{adjustbox}
		\caption{Device Specification}
		\label{tab:SPEC}
	\end{table}
	
	\section{Previous Solutions}
		\subsection{BEE-UTE Board}
			In previous studies of echidna movements, the BEE-UTE board was used \cite{Freakley13} which was developed at the University of Queensland (UQ). It was designed as a general purpose base board for data logging. The board was 22.5mm x 22.5mm and had a 32bit microcontroller onboard as well as sensors for acceleration, magnetic heading, angular acceleration, pressure and temperature. The board also provided headers for future expansion. Further details can be seen in Figure \ref{fig:BEE}. \\
			
			 The board had an incredibly powerful onboard microprocessor and was very expandable whilst retaining a relatively small footprint. However this design philosophy lead to a number of limitations in the context of small animal biologging. The most significant of these limitations is the short battery life, only 40 hours in the field, when also powering an external GPS module. The onboard processor is overpowered for the application and any broken sensors will cause the system to endlessly poll that sensor, halting data acquisition, although this problem can be solved with a firmware patch. \\
			 
			  A less generalized approach to this specific design problem is needed for this project however this resource will be incredibly valuable reference throughout development. The power management electronics and uSD interface, including power transistors, are all very applicable to this project and will likely be incorporated.
			\begin{figure}[H]
				\centering
				\includegraphics[width=350px]{Figures/BeeBoardDiagram.png}
				\caption{BEE-UTE Board System Diagram}
				\label{fig:BEE}
			\end{figure}
			
		\subsection{Camazotz}
			The Camzotz Board, developed by CSIRO \cite{Jurdak13}, is a small tracking board for fruit bats that is very similar in scope to the project described here but has a few key deviations. The board has onboard sensors for GPS, accelerometry, pressure, temperature and acoustic signals, see Figure \ref{fig:Camazotz} for details. \\
			
			With some very clever duty cycling of peripheral sensors and the use of small solar panels the board is energy neutral, which means the board will operate until device failure; battery life is effectively infinite in most cases. A novel method was used to power the sensors; all the power was drawn directly from I/O ports of the microcontroller which allowed the board to completely turn off certain devices when they weren't being used, a significant energy saving compared to putting these devices in sleep mode. Communication of data was accomplished via radio base stations located in known nesting roosts. \\
			
			Despite this being very similar in scope to this project, there are a few design decisions that ultimately make it unsuitable for this application. The solar panels would interfere with the echidnas attempts to warm up in the sun and the lack of any fixed nest for the echidna makes the radio base station approach not appropriate. \\
			
			The Camazotz board is a good example of miniaturized embedded design as the board itself only weighs 30g. The effective power management and GPS chipset both proved to deliver significant power savings and are both components of the design which will likely be factored into this project. 
			\begin{figure}[H]
				\centering
				\includegraphics[width=5cm]{Figures/CamazotzDiagram.png}
				\caption{System Diagram of Camazotz Board}
				\label{fig:Camazotz}
			\end{figure}		
		\subsection{Crane Tracker}
			The CraneTracker \cite{Bennett11} is a wireless sensor network based platform for tracking Whooping Cranes on their migration from Texas through to Canada. The system is built on an Iris Mote with a ZigBee compliant radio transceiver. The actual devices make use of solar panels for extra power and primarily takes GPS readings.\\
			
			 Fundamentally the communication strategy employed by this study is incompatible with the proposed project; the radios use cellular networks to communicate their data, a luxury not available in the Australian outback. Overall this is a good example of a low weight design but is ultimately focused on solving the problem in a drastically different way. \\
			 
			 There are not many specific design problems solved by this product for the primary application, even though it serves the same purpose. \\ 
			 
			 This device illustrates an underlying issue with the literature and the general progression of the art; a movement has occurred towards 'smart' nodes that are able to communicate with each other and surrounding networks, like the cellular one. Unfortunately in the Australian outback these networks are generally not available as Echidnas are not particularly social or return to the same location, making any radio reliant methods unreliable at best for this application \cite{Brattstrom73}.
			 
		\newpage
		\subsection{CritterCam}
			One of the earlier remote sensing applications was the Crittercam \cite{Marshall07} which was expanded from its original analog video camera to a more complete digital system including a variety of data sensors. \\
			
			The Crittercam is primarily a video camera for marine animals. The newest version (Gen V) includes accelerometers, magnetometers, pressure, temperature and flowmeter sensors. All of this is sampled data is written to a MultiMedia Card (MMC), a predecessor to the SDcard. \\
			
			 Some of the biggest successes of the Crittercam are its incredible robustness and ability to actively monitor battery power and change modes when the battery is critical (when low battery is detected, the device will become a radio beacon to aid retrieval). However the reliance on video data is a relic from the earlier models and, compared to the large power cost, is of little use in a lot of research situations.\\
			 
			  Unfortunately the weight of the unit is 1.1kg which is similar in weight to some of the animals the sensor board proposed in this report could be deployed on. This is one of the earliest commercial remote sensing applications and appears here mostly for completeness as the style of approach to the problem, with no reliance on external infrastructure, is aligned with the goals for this project however miniaturizing the technology to such an extent has historically been very difficult.\\
			  
			  The device does show a number of novel design decisions which are appropriate for this project. Since it has been such a long running project, the system engineering has been extensively honed and all the space available has been used well. 
	\newpage
	
	%TODO: Sectiopn that shits on previous solutions
	
	\section{Technical Background}
		Many useful lessons can be taken from the previous products that exist in the art however these alone do not create an entire solution for this application. This section will provide some technical background that is necessary to both fulfill the requirements set out by this project and to adequately justify a number of design decisions. This is not by any means an exhaustive background and some familiarity with embedded systems and electronics design is assumed. \\
		
		 This section only exists to inform the reader of the technologies that need to be understood to be able to justify the following design decisions. For further system details and justification of exact components see section \ref{sec:components}. 
	%Remember: This section is about technology choices, not specific parts
			
		\subsection{Volatile \& Non Volatile Memories} \label{sec:volatile}
			There are two major kinds of memory in electronic systems; volatile and non volatile each with their own power/use tradeoffs. Volatile memory is memory which loses the saved data whenever the power is disconnected whereas non volatile memory will retain memory permanently. \\
			
			The major design tradeoff between these two methods is energy consumption; it is very inefficient to write bursts of small data to a non volatile memory \cite{Sandisk} however the cost is reduced significantly when writing to volatile memory. \\
			
			The system will require some form of non volatile memory however the solution should have both forms of memory on board, to minimize frequency of writing to non volatile memory.
			
			%Expand?
			
		\subsection{Battery Chemistries}
			There are a number of different battery chemistries being used in embedded system applications, the three most common being: Alkaline, Lithium-Ion and Lithium-Polymer. \\
			
			Alkaline cells rely on the interaction between zinc and mangnanese (IV) oxide. These cells are typically not rechargeable and can be quite heavy as they are typically produced inside a steel case. They also have a problem with high current draws; the effective capacity of the battery decreases with increasing load current. \\
			
			Lithium-Ion is probably the most common battery type seen in robotics. They have a large capacity to weight ratio and are rechargeable. However they are most commonly produced in a hard plastic case which increases the weight significantly. \\
			
			Lithium-Polymer or, more correctly, lithium-ion polymer is the same chemistry as a lithium ion cell, but packaged in a soft case. This makes them substantially lighter than other chemistries per unit charge as shown in Figure \ref{fig:BAT} but makes them susceptible to damage. \\
			
			\begin{figure}[H]
				\centering
				\includegraphics[width=14cm]{Figures/EDC.png}
				\caption{Energy Density of Various Chemistries \cite{icc}}
				\label{fig:BAT}
			\end{figure}		
	
			This damage is a significant factor for this project. When lithium cells, and a few other battery types, are damaged, they can sometimes undergo a state called thermal runaway, where the entirety of their energy is converted to heat in a few seconds. This can be quite violent and appropriate protections need to be taken into account to stop this from happening to any batteries placed on an animal as it would almost certainly prove fatal. Another safety issue which is relevant to all kinds of batteries, but especially coin cell and alkaline batteries with exposed terminals, is of ingestion. When batteries are ingested they can short across internal organs and burn their way through and/or have their cases eroded by stomach acid which releases the incredibly toxic interior. This cannot happen in this project and every measure reasonable should be taken to reduce the risk of it occurring.
			
		\section{Proposed Solution}
		Understanding the physiology and behaviour of echidnas informed the design decisions regarding which sensors would be needed but this still fails to address the primary motivator of this project; achieving a longer operational lifetime. The proposed solution will utilise three novel methods in order to reduce the power consumption to a level where the board can operate for around a week on a single charge. \\
		
		The first, and most obvious, design decision is to use the microcontroller to supply power to the various sensors, allowing them to be shutoff entirely when they are not necessary. This has a number of drawbacks that have to be managed; sensors can be unstable for a short period after startup and a microcontroller will need to be able to source significant amounts of power from its I/O ports or else a lot of board space will have to be invested into MOSFET switches. \\
		
		The second design decision is to do with memory; as described in section \ref{sec:volatile} it is power inefficient to have frequent, small writes to non volatile memory. Instead of the simpler model employed for other systems, this system will use a multi level cache. There will be two volatile memory stores; a local store on the microcontroller and a further 2Mbit provided by external SRAM. This will serve to significantly reduce the frequency of writes to the $\mu$SD card to the point where they are practically negligible. \\
		
		The final design decision to reduce the power consumption is to have an adaptive sensing rate. Since echidnas can spend a significant amount of time not moving during hibernation [!REF] it would not be sensible to continue sampling at full speed. Depending on the activity observed, which can be quantified by any metric, the sampling period will change allowing the sensor to take relatively infrequent measurements when the echidna is stationary but increase the sampling ratio and collect more data when it is more active. \\
		
		These three design decisions will be implemented on a custom made board and will allow it to achieve a long operating life in the field of around 1 week.
		

\chapter{Design Overview}
	
	\section{Hardware} \label{sec:components}
		The general approach to component selection for this project has been a careful balancing act of size, power consumption and in some cases weight. Choosing the best devices to start from was absolutely essential in designing a system to meet the specifications. A few of these were selected over a few revisions; initially the project was implemented on small custom PCB's in order to test functionality. \\
		
		The designed system has utilised a few key elements from the solutions looked at previously in order to accomplish the stated specification. The microcontroller can turn peripheral devices on and off directly from the IO pins, there is a multilevel cache made of volatile and non volatile memories and there is an adaptive sampling rate to get the best battery life out of the device. This will enable the microcontroller to spend most of the period sleeping, only moving to wake state to make a short series of measurements. An architecture overview is shown in Figure \ref{fig:HWD}.
		
		\begin{figure}[H]
			\centering
			\includegraphics[width=11cm]{Figures/HWD.png}
			\caption{Hardware Diagram}
			\label{fig:HWD}
		\end{figure}		

		
		\subsection{Microcontroller}
		%TODO Make it read like not shit
		In the context of this application, relatively little processing power is needed, as there is only a small amount of processing occurring onboard; the microcontrollers main purpose is to collect and store information. What is required is an extremely low current draw, small physical size without relying on Ball Grid Array (BGA) footprints and a bevy of peripheral communication abilities. \\
		
		Using the microcontroller to source power to peripherals directly from the I/O pins introduces a number of considerations. It will be necessary for the microcontroller to be able to source enough current from the I/O pins to power the devices without excessive heating or any damage. This setup is more preferable than using discrete MOSFET switches as they can take up a significant amount of space on the PCB. \\
				
		The microcontroller was considered to be one the key choices with regards to achieving the operating lifetime. In the field there are a number of competing device lines and technologies in the super low power applications such as Microchip's nanoWatt, Atmels picoPower and Texas Instruments MSP430 series. \\
		
		All these device lines could theoretically be used for the device when only considering power usage, they all have active mode currents in the range of $\mu$A/MHz and have enough peripheral functionality and I/O ports to satisfy the requirements. \\
		
		Atmel's picoPower line is quite young and expensive, which is not very attractive in this range of products however it was the most familiar. Using one of the development boards quickly revealed that, while functional, the microcontrollers were quite susceptible to soft faults and would often reset without notice. This combined with the lack of extensive documentation, an overly bloated framework and a proprietary, closed source chip used to program the device lead to the adoption of an alternative solution being sought. \\
		
		The two competing microcontrollers left belonged to the MSP430 series and the PIC24F series. Eventually PIC24F was chosen over the MSP430 as it was found to be significantly better documented and had one extra key feature; remappable peripherals. The PIC24F series can move the peripheral fucntions, like I2C, SPI, UART and others, onto any available I/O pin. This flexibility allowed for the most freedom when performing PCB placement as there would rarely be a situation where a pin was stuck in a tricky place. This user friendliness was of course only relative and there were a number of errors in documentation as is common in the newer chipsets. \\
		
		The PIC24FJ128GA306 was the final microcontroller chosen \cite{PIC24} and boasted current draws as low as 150 $\mu$A/MHz in active mode and around 400 nA in sleep mode with a real time clock enabled. The device is also relatively small, just 10mm by 10mm by 1mm, making it ideal for these applications. There is no BGA version of this exact chip but there is another in the PIC24FJ128GA310 family but due to the increased pin count is the same size. \\
		
		To verify the basic design and become familiar with the microcontroller an extremely basic breakout board was made, shown in figure \ref{fig:PICBREAK}. The board actually exposed problems with programming the device; the recommended capacitor on the MCLR pin, effectively the reset pin of the device, made the bus capacitance too high for the programmer to switch at speed. In newer versions this capacitor still appears in the schematic but is left unsoldered until the final program is loaded on the board although it is not strictly necessary. \\
		
		\begin{figure}[H]
			\centering
			\includegraphics[width=11cm]{Figures/PICBREAK.png}
			\caption{PIC24F Basic Breakout}
			\label{fig:PICBREAK}
		\end{figure}		
		
		\newpage
		\subsection{Sensors}
		Sensors can have a noticeable impact on battery life. Some sensors, such as gyroscopes, can draw current in the range of mA. For most sensors, absolute accuracy is the ultimate design goal and so power consumption typically suffers. Luckily for most sensors, there exist some, relatively expensive, solutions that are highly configurable in order to customize the balance between accuracy and power consumption. \\
		
			\subsubsection{Movement Sensing}		
			Detecting animal movement usually requires the synergy of several sensors. Classifying movement states and localizing position are typically done separately. Movement is usually sensed by measuring acceleration of which there are two main approaches; measuring the acceleration along an axis (accelerometer), or measuring rotational acceleration across axes (gyroscope). Gyroscopes typically consume more power than accelerometers by a factor of 10 or more \cite{InvenMPU9150} so for this, low power, application, accelerometers will be used to measure movement. \\
						
			There are a number of exciting new entries into the low power accelerometry chip market. Most notable is the Bosh BMI160 \cite{bosch15} which has ultra low operational currents of less than a mA with both the accelerometer and gyroscope enabled. \\
			
			Unfortunately the BMI160 could not be used as the data would not be compatible with the existing set of data from the InvenSense MPU9150 \cite{InvenMPU9150} on the BEE-UTE board. The MPU9150 is an integrated inertial measurement unit (IMU) with an onboard accelerometer, thermometer, gyroscope and magnetometer. The MPU9150 draws 900uA with the accelerometer enabled, which is more than enough for this application as the device will spend the vast majority of its time powered down. 
			
			\subsubsection{Pressure \& Temperature}
			The temperature sensor onboard the MPU9150 is not accurate enough for the levels of precision required and does not have an onboard pressure sensor. In order to get the most accurate reading of either, pressure and temperature should be sampled together. \\
			
			The Measurement Specialties MS5637 \cite{MEASPRESSURE} was chosen for this application as it boasted a super low power consumption, was relatively cheap and has a small footprint. There were a number of others in its class but a lot of them had onboard processing, the MS5637 instead requires the microcontroller to read in the calibration words and use them to convert the unitless measurements into metric values. This allowed the MS5637 to draw a near insignificant amount; only 0.6 $\mu$A.
			
			\subsubsection{Light Sensor}
			Most digital light sensors required a comparatively large amount of power to operate and had relatively large footprints. In light of this a completely analog light sensor was chosen, the Avago APDS-9005-020 \cite{AVAGOLIGHT}. \\
			
			The purpose of the sensor was to primarily tell if the echidna was resting in the shade or out in direct sunlight so metric values weren't important and with the PIC24F's onboard 10 bit ADC, precision wasn't a problem for this sensor. It was easily able to discern between light and dark. \\ 
			
			%TODO: Maybe reorganise headings so this isn't under light sensor?
			To test the three simpler sensors a simple breakout board was created as per the schematic shown in Figure \ref{fig:SENSEBREAKSCH} to create the PCB shown in \ref{fig:SENSEBREAKPCB}. These were designed as per the application notes in the relevant datasheets. Primarily this informed the addition of larger decoupling capacitors as sometimes the output from the microcontroller could waver when altering a lot of I/O pin states in quick succession and the use of smaller I2C pull up resistors; it was found the MPU-9150 was very particular about rise times. The board also demonstrated the need to glue down the light sensor as the pads alone do not form a satisfactory mechanical connection.
			
			\begin{figure}[H]
				\centering
				\includegraphics[width=15cm]{Figures/SENSEBREAKSCH.png}
				\caption{Sensor Breakout Schematic}
				\label{fig:SENSEBREAKSCH}
			\end{figure}		
			
			\begin{figure}[H]
				\centering
				\includegraphics[width=6cm]{Figures/SENSEBREAKPCB.png}
				\caption{Sensor Breakout PCB}
				\label{fig:SENSEBREAKPCB}
			\end{figure}		
			
\newpage
			\subsubsection{GPS Localisation}
			%TODO: Reads awkwardly
			Global Positioning System (GPS) modules are devices which interact with satellites to determine their exact position. Implementation specifics vary but the fundamental concept is for the module to establish communication with four or more satellites using an external antenna and the align the internal clock with them to localize its position. \\
						
			This requires fairly high level floating point arithmetic which is usually provided by the module itself. These satellite fixes can take as long as 30 seconds. A typical GPS module can draw as much as 50mA in active mode \cite{Carroll10}.
						
			The GPS was probably the hardest sensor to decide upon. It had to be small, power efficient and acquire a satellite fix very quickly, features that are rare in such devices. Eventually the u-blox MAX6 \cite{ubloxGPS} was chosen. \\
			
			The MAX6 can draw currents as small as 12mA during a 1Hz update rate, as much as five times smaller than the norm for a GPS. This however comes with a lot of drawbacks, namely price. The device is \$60 USD and can, at the time of writing, only be bought in Australia directly from the manufacturer. \\
			
			These concessions had to be made for this project however, as the GPS alone would otherwise require far more current than every other component combined otherwise. \\
			
			In order to evaluate the performance of the board another breakout board was designed and implemented as per the application note. Unfortunately due to time constraints the board wasn't able to be tested before final manufacture had to begin. The schematic is shown in Figure \ref{fig:GPSBREAKSCH} and the PCB in Figure \ref{fig:GPSBREAKPCB}.
			
			\begin{figure}[H]
				\centering
				\includegraphics[width=15cm]{Figures/GPSBREAKSCH.png}
				\caption{GPS Breakout Schematic}
				\label{fig:GPSBREAKSCH}
			\end{figure}		
			
			\begin{figure}[H]
				\centering
				\includegraphics[width=6cm]{Figures/GPSBREAKPCB.png}
				\caption{GPS Breakout PCB}
				\label{fig:GPSBREAKPCB}
			\end{figure}				
			
			\subsubsection{Battery Meter}
			With non volatile data storage, corruption of memory, especially in the presence of a under voltage event, becomes more likely. The battery meter will help the application track the battery voltage allowing it to shutdown safely when the battery is in danger of an under voltage event. \\
			
			Non volatile memories typically utilise more advanced data storage techniques using file systems designed to organise data better. The significant downside to these file systems is when power is lost mid write, it is very likely that the file system will become corrupt. The obvious solution is for the system to shutdown safely before the battery level becomes critical. A battery meter can track the state of charge and shutdown the system safely before corruption of data occurs. \\
			
			The battery meter chosen was the Maxim Integrated MAX17040 \cite{max17} mainly due to the low cost and size. %More?
			
		\newpage
		\subsection{Data Storage}
		One of the key design decisions to this project is to have a multilevel cache with volatile and non volatile memories shown in Figure \ref{fig:MLD}. The first layer would be provided by the mircocontroller itself, with internal RAM. The next layer would be comprised of external serial SRAM. The final layer would be a regular, off the shelf $\mu$SD card. \\
		
		Originally the 23LC512 Chips from Microchip were selected and the board shown in Figure \ref{fig:MEMBREAKPCB} was used to develop. These were functional chips but the 23LCV1024 chips were later found which were around the same price and power consumption, but doubled the available memory from 512kbit to 1024kbit so they were the memory modules used in the final version. \\
		
		\begin{figure}[H]
			\centering
			\includegraphics[width=6cm]{Figures/MEMBREAKPCB.png}
			\caption{Memory Breakout PCB}
			\label{fig:MEMBREAKPCB}
		\end{figure}	
		
				
				\begin{wrapfigure}{r}{0.4\textwidth}
					\centering
					\includegraphics[width=5cm]{Figures/MLD.png}
					\caption{Memory Architecture}
					\label{fig:MLD}
				\end{wrapfigure}
		
		$\mu$SD cards can draw large currents from about 50mA to 200mA in write mode \cite{Sandisk} and as such, can not be relied upon for primary storage; the cost of small writes is simply too great. Instead the approach taken was to store as much as possible on the microcontroller then write this out in bursts to the volatile SRAM. Once this was full, an entire 2Mbit write could occur to the $\mu$SD card, greatly reducing the power consumption. \\
		
		With the selection of this serial SRAM and generating around 160 bytes of sensor readings every second (at a 1 Hz sampling rate) the $\mu$SD card will only need to be written to every 26 minutes. Without the serial SRAM, this would have been reduced to only 2 minutes. This reduces the effective duty cycle of the $\mu$SD card to the point where it is almost negligibly small for all but the largest write events.
		
		\subsection{Power Supply}

		There are two major kinds of power supplies being used in modern systems; linear and switching regulators \cite{TI2011}. Linear regulators use a simpler, cheaper design whereby the output voltage is always lower than the input and the power loss inside the regulator is proportional to the current flowing. Switching regulators use very little power comparatively but even with no load circuit connected they will draw some current known as the quiescent current. They also can introduce switching noise into the design. \\
		
		Both of these designs have merit to be used in this project however switching supplies must be chosen as they can handle a wider range of inputs both above and below the selected output voltage. \\
					
		The power supply is one area of design where any mistakes have a cumulative effect on system power consumption. Quiescent currents and inefficiencies can become very significant in the face of relatively minor design errors. \\
		
		In order to maintain relatively safe with these issues, and to not fix what isn't broken, the same components as appeared on the BEE-UTE board were chosen. These devices are both Texas Instruments branded: the BQ24072 battery charging and power path management IC \cite{TIUSB} and the TPS63030DSK switching buck-boost regulator \cite{TIBUCK}. \\
		
		The BQ24072 allows for a user to charge the battery onboard or optionally power the device from the USB bus. This enables a potential fixed position application or an alternate, 5 volt source to power the device, although battery voltage tracking would not be available. In addition, the BQ24072 also has a number of thermal protection and short-circuit protections which will prove themselves essential in the rugged environment of the Australian outback. \\%and my care lol
		
		The TPS63030 is a fairly standard buck-boost switching regulator with a relatively flat efficiency curve of around 80\% for most of the operating range of currents. There is also around a 50uA quiescent current, which is very small for the price range of the device. The TPS63030 retails for approximately \$6 AUD and most power supplies that can provide higher efficiencies across the incredibly large range this device will have will be too costly for this project. \\
		
		%TODO: Power generation PCB board
		%TODO: SCHEMATIC + PCB + PROBLEMS:
		%TODO: FOOTPRINT ON TPS63030DSK-T
		The TPS63030 and BQ24072 were put onto a breakout board designed as per the application note in the datasheets. The schematic appears in Figure \ref{fig:PWRBREAKSCH}. There were a few errors in the PCB that made testing of this circuit impossible at the time; the footprint for the TPS63030 was reversed and the land pads were too small for the pins. These were manually adjusted to be wider than the reccomended for later PCB's. An error that appears here, but wasn't detected until after the first full system PCB as produced, is around the output voltage on the TPS63030 (marked U1 in Figure \ref{fig:PWRBREAKSCH}). The two resistors form a voltage divider to create a feedback reference that the ship uses while the 100nF capacitor in parallel reduces ripple in this network. This feedback network however is not isolated from the actual output; the 'ground' the TPS63030 is driving against is about 500mV (the value of the feedback voltage) leading to the output voltage being closer to 4V. This was not detected until the first system was built unfortunately and cost a few weeks of development time. \\
		
		\begin{figure}[H]
			\centering
			\includegraphics[width=15cm]{Figures/PWRBREAKSCH.png}
			\caption{Power Breakout Schematic}
			\label{fig:PWRBREAKSCH}
		\end{figure}	
		
		%TALK ABOUT SELECTION OF PASSIVES
		Programming the output voltage on the TPS63030 is remarkably simple; Texas Instruments provide all the relevant equations and best practices for layouts and component specifications. The feedback voltage is fixed to around 500mV inside the device, although in practice this varied slightly depending on the load attached, which resulted in some fine tuning on the finished product. See Appendix [!REF] for detailed calculations and information about selection of passives and their specifications.
		
		\subsection{Batteries}
		Now that the components are selected, it is appropriate to draft a power budget to better inform the size of battery needed. It has already been decided to go with lithium polymer batteries, which are significantly lighter per unit charge than most other types which should allow maximum flexibility. \\
		
		Table \ref{tab:PWR} shows the required battery sizes for various power management strategies. The three strategies are no control (N.C.), basic control (B.C.) and advanced control (A.C.) and refer to the extent to which duty cycling certain components is performed. Note that an analysis like this will not factor in things like inefficiencies, quiescent currents,  self discharge etc so these results more serve to provide an upper bound on performance. Actual performance could be as low as half of these predicted values due to a the effects mentioned above and an uncountable amount of other factors.\\ %Bit weasel word
		
		\begin{table}[H]
			\centering
			\begin{adjustbox}{max width=\textwidth}
				\rowcolors{2}{white}{lightgray}
				\begin{tabular}{c | c | c | c | c | c }
					Device & Active Current & Sleep Current & N.C. Duty Cycle & B.C. Duty Cycle & A.C. Duty Cycle\\
					\hline
					PIC24F          & 150$\mu$A & 410nA  & 100\% & 20\%  & 10\%  \\
					MAX6 GPS        & 12mA      & -      & 100\% & 100\% & 5\%   \\
					Light Sensor    & 400$\mu$A & -      & 100\% & 100\% & 10\%  \\
					Accelerometer   & 925$\mu$A & 3$\mu$A& 100\% & 20\%  & 10\%  \\
					Pressure Sensor & 0.6$\mu$A & -      & 100\% & 100\% & 10\%  \\
					$\mu$SD Card    & 50mA      & -      & 25\%  & 10\%  & 5\%   \\
					\hline
					\bf BATTERY REQUIRED & - & - & 8.72A-h & 7.6A-h & 1.3A-h\\
				\end{tabular}
			\end{adjustbox}
			\caption{Battery requirements by management method}
			\label{tab:PWR}
		\end{table}		
		
		It is immediately clear that some heavy management of duty cycle is necessary for this project to work correctly. A battery of about 8A-h would be far too heavy for the application; around 200 grams alone. 1.2A-h lithium polymer batteries are significantly more common, come in a variety of sizes and only weigh about 20 grams. Alternatively, to improve the battery life, a 2A-h battery can be connected which weighs 40 grams.
		
		\subsection{Connectors}
		A frequently overlooked component in system design is user end connectors being of poor quality or being of a simple 0.1 inch pitch unkeyed connector. It is an unnecessary risk for the board to have these connectors as it also increases the risk of the battery detaching from the board during operation.\\
		
		A standard microUSB type B plug was used for the battery charging, due to its small size and being a common cable throughout the world. A JST connector was used for the battery input, to prevent any users from accidentally connecting it backwards and also allowing the system to operate with any single cell lithium based battery which will expand the possible applications significantly as the user won't be required to resolder anything to change the battery. 
		
	\newpage
	\section{Firmware}
		The approach to firmware was primarily iterative; an initial plan was laid out early in the project's life but this was repeatedly updated and refined in the face of new information or implementation subtleties and restrictions. The choice to go without an embedded operating system was not taken lightly; an embedded operating system can save the developer having to delve into the specifics of a microcontrollers architecture. Ultimately it was decided that this benefit was not worth the inevitable lack of flexibility and operating overhead. \\
		
		Fundamentally the system had a fairly straightforward task: during each sampling period, turn on all the sensors, give them time to settle, take the measurements then push the data out to the multilevel cache. The original high level flowchart is shown in Figure \ref{fig:FWD}.
		
		\begin{figure}[H]
			\centering
			\includegraphics[width=11cm]{Figures/FWD.png}
			\caption{Firmware Flowchart}
			\label{fig:FWD}
		\end{figure}		

		\newpage
		\subsection{Design \& Implementation} %Working title
		The design was always centered around simplicity and, while that may be highly subjective, a large effort was put forward to name that. For structure and flow control the OpenBSD kernel maintainers style guide \cite{BSDstyle} was used, as it is well suited to such a low level environment and was familiar. \\
		
		All the firmware developed in this thesis is original except for three exceptions. Microchip provide some skeleton structures to get started, the FatFs SD card driver, under a completely free license and some of the onboard peripheral code was either informed by or written entirely by JL from Engscope.com \cite{JL2013}. \\
		
		Code was stored on Github in a front facing repository. Having a reliable backup system for firmware development is always important as it was necessary more than a few times to revert to an earlier commit to check if any hardware had failed. The repository is online at: \url{https://github.com/Albert-Tate/ENGG4801-ECHIDNA}.
		
		\subsection{Functionality}

		The implemented system can interact with light, temperature, pressure and accelerometry sensors to acquire data. This data can then be pushed to the multilevel cache however, due to some hardware failures, only part of this is tested. The sensors can be turned on and off directly via I/O ports. The system, in lieu of an available SD card, can still push the data out across a UART port. The system is able to measure its state of charge and subsequently shutdown if the battery is at risk of creating an undervoltage event and the system is able to adapt its sampling rate to become appropriate for the level of activity observed. \\
		
		%TODO: Can extend this section definitely ^^^
		\subsection{Key Excerpts}
		This section will detail some key excerpts from the code whose function would not be obvious at first glance. This section will not discuss basic things like configuring devices, entering sleep modes or manipulating GPIO pins to provide power with devices as they are relatively trivial. \\
		
		There are three major sections of code which should be discussed; the multilevel cache, the adaptive data rate and the battery state of change (SOC) and preventative shutdown measures. In the online repository all code will be commented however any code snippets here will have no comments appearing for the sake of brevity and will instead be explained in text. \\
		%TODO: Battery meter, multilevel cache, variable data rates
			\subsubsection{Multilevel Cache}
				\begin{lstlisting}
if(meas_index == MAX_MEASURE && BATT_SOC > MIN_SOC) {
	uint32_t i;
	RTC_ALARMOFF(); 
	if(meas_index + mem_pointer < EXT_MEM_SIZE) {
		for(i = 0; i < meas_index; i++) {
			EXT_MEM_write_buffer(0, mem_pointer, sizeof(struct MEASUREMENT), (uint8_t*)&(measure[i]));
			mem_pointer += sizeof(struct MEASUREMENT);
		}
		
	} else if(meas_index*sizeof(struct MEASUREMENT) + mem_pointer < 2*EXT_MEM_SIZE) {
		for(i = 0; i < meas_index; i++) {
			EXT_MEM_write_buffer(1, mem_pointer - EXT_MEM_SIZE, sizeof(struct MEASUREMENT), (uint8_t*)&(measure[i]));
			mem_pointer += sizeof(struct MEASUREMENT);
		}
	} else {
		uint64_t j;
		for(j = 0; j < (EXT_MEM_SIZE/sizeof(struct MEASUREMENT)/MAX_MEASURE); j++) {
			
			for(i = 0; i < MAX_MEASURE; i++) {
				EXT_MEM_read_buffer(0, i + j*MAX_MEASURE, sizeof(struct MEASUREMENT), (uint8_t*)&(measure[0]));
#ifdef SD_CARD                      
				SD_CARD_WRITE_STRUCT(measure);
#endif									
			}

		}
		for(j = 0;
			j < (EXT_MEM_SIZE/sizeof(struct MEASUREMENT)/MAX_MEASURE);
			j++) {
			
			for(i = 0; i < MAX_MEASURE; i++) {
				EXT_MEM_read_buffer(1, i + j*MAX_MEASURE, sizeof(struct MEASUREMENT), (uint8_t*)&(measure[0]));
#ifdef SD_CARD
				SD_CARD_WRITE_STRUCT(measure);
#endif
			}
		}
	}
#ifndef SD_CARD
	UART1Init(6);
	delay(100);
	UART_SEND_PACKET();
	UART1PutChar('\n');
#endif
	meas_index = 0;
}					
				\end{lstlisting}
				The multilevel cache needs significant explanation to be understood as it is a very dense section of code. Firstly some variables and their purposes are listed below: \\
				\begin{description}
					\item[meas\_index] Effectively a pointer for the local memory. Counts from 0 to MAX\_MEASURE and represents the index at which the next set of data should be loaded into the measure struct.
					\item[mem\_pointer] The contiguous address for the external SRAM chips. This variable indexes across both chips so the maximum value is 2*EXT\_MEM\_SIZE.
				\end{description}
				
				There are two key flows through this section of code: if meas\_index + mem\_pointer is less than the maximum allowable size (2*EXT\_MEM\_SIZE), which means that there is space available to store all the current measurements onto the SRAM, pushes data onto the SRAM and updates the mem\_pointer variable. There is a single function to address both memory modules; 'EXT\_MEM\_write\_buffer' whose first argument specifies which memory module to use. \\
				
				The second flow through this code occurs when there is no more room on the external SRAM. In this scenario the data has to be then written to the $\mu$SD card. Here is where things get slightly trickier to comprehend. Effectively the same loop is repeated twice again for each memory module and the data is read from each memory module in blocks corresponding to the maximum size that can be stored locally (MAX\_MEASURE) and then written to the $\mu$SD card using the 'SD\_CARD\_WRITE\_STRUCT' function. 
			\subsubsection{Adaptive Data Rates}
				\begin{lstlisting}
ACTIVITY = measure[meas_index].X_ACC + measure[meas_index].Y_ACC + measure[meas_index].Z_ACC;

activity_sticky--;
if(activity_sticky < 0) {
    if(ACTIVITY < THRESHOLD - 2000) {
        ALARM = 1;
        activity_sticky = 0;
    } else if(ACTIVITY > THRESHOLD + 2000) {
        ALARM = 0;
        activity_sticky = STICKY_MAX;
    }
}
        		\end{lstlisting}
        	This section of code will adapt the data sampling rate by manipulating the ALARM variable, which then sets the real time clock (RTC) alarm. Unfortunately the internal RTC in the PIC24F is very limited and only two separate sampling rates are viable; 1 and 2 hertz. \\
        	
        	There are two key ideas here worth discussing; the 'ACTIVITY' variable and the 'activity\_sticky' variable. The ACTIVITY variable is currently calculated in a very simple manner but could be calculated by any metric or heuristic available. Since the PIC24F is a fairly slow microcontroller, a simple addition was opted for rather than a geometric mean. The 'activity\_sticky' controls the 'length' of the changed rate. During testing it was found to switch between the two quite rapidly and any condition to trigger a higher sampling rate would quickly disappear. The sticky variable allows for the increased data rate to linger for a few moments so that more data can be captured about what had just happened.\\
        	
        	Obviously a more flexible RTC would have been desirable but the key limiting factor in fleshing out this functionality is a lack of time. If the accelerometer is programmed to go into low power modes and generate an interrupt based on a certain accelerometry condition, larger times between samples could be used. This was the planned feature but due to a combination of issues that delayed manufacture, there was not enough time to implement it reliably.
        	
			\subsubsection{Battery SOC}
			
			The battery SOC 'shutdown' procedure is very important although it is incredibly simple. The state of charge is requested from the device and the only place it appears is at the start of the multi level cache snippet: \\
			\begin{lstlisting}
if(meas_index == MAX_MEASURE && BATT_SOC > MIN_SOC) {
...
}
			\end{lstlisting}
			This single condition will stop the system from writing any memory while the battery state could be dangerous. This is considered preferable to shutting down entirely as a single bad read, or a few bad reads in short succession, could bring the system down unnecessarily.\\
	\newpage
	\section{Manufacture}
		Manufacture of miniaturised designs is always a challenge and can prove difficult both in producing PCB artwork and physically constructing the device. Since this is a prototype, everything had to be hand constructed which has somewhat limited miniturisation; namely in that BGA based footprints cannot be reasonably used. 
		
		\subsection{PCB Design}
			The largest concern during PCB design was size, as the size of the device will limit the possible cases used and, as the boards and the copper within are quite heavy, can have a noticeable impact on final system weight. \\
			
			%Talk about board physical dimensions?
			The board was designed to have roughly the same physical dimensions as a standard USB stick but this had to be increased slightly to 20mm x 60mm for practicality reasons. \\
			
			The PCB artwork was developed using the Altium Designer suite of tools and, by the last iteration, was comprised of 6 layers; four signal layers and two plane layers. This was a necessary design decision to not only shield components from electromagnetic interference (EMF) from components on the other side but to also act as a heatsink for the large transient currents that could be experienced by the system. \\
			
			There was a substantial effort wherever possible to reduce EMF however on such a small board, some concessions had to be made. The power section of the board, with its heavy switching noise, was separated away from the sensors and the microcontroller. The serial SRAM will spend most of its time idle, so during the sampling period there should be relatively little EMF and this was exploited by placing the bulk of the sensors on the opposite side of the board. \\
			
			The largest concession made was with the GPS module. It is placed directly underneath the microcontroller. This was the primary motivation for the two plane layers and is further alleviated by the small airgap between the PCB and the microcontroller. Despite this a completely isolated section of board was allowed for the antenna so the actual performance should not be hindered in any noticeable way. \\
			
			Wherever appropriate, the smallest passives were used. This meant 0402 footprints for every passive except for the power inductors and the user LEDs, for specification and visibility reasons respectively. The picture shown in Figure \ref{fig:PCB} shows the final PCB with the control circuitry highlighted in green, the sensing circuitry in blue and the power supply circuitry in red. \\

		\begin{figure}[H]
			\centering
			\includegraphics[width=9cm]{Figures/PCB.PNG}
			\includegraphics[width=9cm]{Figures/PCBMarkup.PNG}
			\caption{Final PCB}
			\label{fig:PCB}
		\end{figure}		
			
		\subsection{Bill of Materials}
		%TODO: Maybe make this not shit
		The bill of materials for the project is presented below in Figure \ref{fig:BOM} and is a complete mapping of parts to their specifiers on the board. All the prices are quoted as single purchase quantities and it is assumed (incredibly roughly) that the USD is equal to the AUD. \\
		
		The assumption that the USD was equal to the AUD was more appropriate at the start of the project than it is now. Almost all of these prices have gone up around 40\% due to the fall of the AUD. Components without a supplier must be purchased on request from the manufacturer and, for practicality reasons, should probably be replaced with an equivalent, easier to find, part in the next revision.
		\begin{figure}[H]
			\centering
			\includegraphics[width=15cm]{Figures/BOM.PNG}
			\caption{Bill of Materials}
			\label{fig:BOM}
		\end{figure}	
		

		\subsection{Construction}
		There are a number of practical difficulties with construction that need to be fixed in subsequent iterations but in the current state, this needs to be done to be able to build the device. \\
		
		Some devices on the top side have a thermal pad directly underneath them. This helps with a stable ground connection and reduces self heating but it also prevents the use of any glues. Since these components are QFN footprint; they can not be reliably soldered by hand. The issue arises on the reverse side where there is a QFN style footprint on the antenna which is only rated to go through the oven once. \\
		
		This means that the only way to reliably solder the device is to use non-leaded solder paste on the top side, which has a higher melting point, and apply the top side components first. Then use leaded solder, with a much lower melting point, on the reverse side. This will stop the solder joints remelting and any components falling off the device during the soldering process.
		
	\section{Integration}
	\subsubsection{Case}
	The purpose of this design is to be used in a wide variety of entirely uncontrolled, and very hostile, environments. As such for the device to survive for longer than a few moments it must be protected by a case. This case would need to be waterproof and shock resistant as well as quite small. \\
	
	Initially several options were drafted to construct a case out of polyethylene from a 3d printed mold fitted with an off the shelf o-ring to prevent moisture seeping in. This case would have weighed less than 5 grams and would have vastly improved the size of battery connected to the device. \\
	
	Unfortunately due to a number of practicality and time issues a completely off the shelf solution was sought. The ideal case in this scenario would be a small specimen container commonly found in biology labs. The screw top would allow for a relatively waterproof design to start with, and a small o-ring would improve it significantly. A picture of possible enclosures is shown in Figure \ref{fig:CASE}.
	
	\begin{figure}[H]
		\centering
		\includegraphics[width=9cm]{Figures/CASE.JPG}
		\caption{Candidate cases}
		\label{fig:CASE}
	\end{figure}			

	Of the three cases pictured in Figure \ref{fig:CASE} only the red capped one could be used for the final PCB. The yellow cap was about 5mm too short and an appropriate battery could not be sourced in time for the clear capped container. The red capped container leaves a lot of air room and is far from ideal; the sensor and battery would have to be taped down to minimise internal movement.\\
	
	\subsubsection{PCB Fabrication \& Development}
	The PCB's for this project were designed using the Altium Designer suite of tools and went through several iterations to arrive at the final revision. \\
	
	Initially large breakout PCB's were created to test basic functionality and generally make it easier to debug a circuit. The only significant change from this stage of development was the adoption of a different SRAM chip as the existing one was found to be too power hungry. \\
	
	The initial entire system PCB took several weeks to develop due to component sourcing issues. It was also entirely non functional due to a mistake when drafting the schematic for the power supply; the output and the feedback were not properly isolated leading to the TPS63030 controlling the output voltage against a floating ground. It was a simple process mistake but it alone cost about 2-3 weeks of the project development process which stopped several firmware features from being fleshed out adequately. \\
	
	The final PCB was constructed by hand, sans GPS due to sourcing issues, and were mostly functional except for the two small errors discussed in Section \ref{sec:PCBERROR}. The final board features a user LED, for rough debugging purposes, a programming header for programming and debugging, a UART output and all the other hardware features required of the project. A picture of the second to last revision is shown in Figure \ref{fig:PCB}.
	
%	COMPARE LV SLEEP TO WHILE 1
%	while 1 152.8mV		15mA
%	LV		 73.1mV		7.3mA
	
		\begin{figure}[H]
			\centering
			\includegraphics[width=6cm]{Figures/finalpt1.png}
			\caption{Revision 2 of the Design}
			\label{fig:FIN}
		\end{figure}	

	\newpage
	\subsubsection{Visualisation of Sensor Data}
		Visualisation of data was accomplished through a relatively simple python script. As discussed in Section \ref{sec:PCBERROR} the memory architecture was damaged and therefore the only way for data to exit the system is through the UART bus. The python script simply takes binary data from the UART bus and writes the received data to a .csv file. \\
		
		The second script takes these .csv files and generates an interactive webpage to view them with. This was done using the Bokeh library for python, which is still in a very early experimental state. The output is shown in Figure \ref{fig:VISDATA}. It is of note to mention that all the x axes are linked; if you see an interesting event and zoom in on it on the accelerometry output, the x axis bounds will be replicated in the other graphs allowing direct comparisons to be made.
		
				\begin{figure}[H]
					\centering
					\includegraphics[width=15cm]{Figures/VISDATA.png}
					\caption{Data Visualisation}
					\label{fig:VISDATA}
				\end{figure}
		
		All of these scripts are online in the github repository and are submitted with the project.
		
\chapter{Discussion}

	\section{Validation of Design}
		The design and construction process for this project was iterative, as most engineering designs tend to be, and went through several versions before some concrete testing could be done. \\
		
		There were three main targets to achieve with this project: \\
		\begin{enumerate}
			\item Echidna appropriate volume and total weight less than 50 grams
			\item An enclosure rated at IP67 or better
			\item An operational lifetime of a week or better
		\end{enumerate} 
		Due to a number of development issues involving time constraints and component sourcing not all of the functionality could be completed but the design does satisfy these three targets or provide significant evidence that they would be satisfied.\\
		
		%%Talk about final features of design
		%Visualization etc
		\subsection{Size \& Weight}
		The final PCB produced, which was very similar to \ref{fig:FIN} but with a rotated battery input and some miscellaneous fixes to usability, weighs 6.55 grams.
		
		The final container used, due to an oddly shaped battery, is the red capped container in Figure \ref{fig:CASE}. This container on its own weighs 27.65 grams. \\
		
		The battery, as mentioned before, weighs 22.6 grams. This brings the total system weight to 56.85 grams (measured, not calculated). This is slightly more than the initial requirements but a more appropriate case could alleviate this issue significantly. This would allow for any animal around 1.1kg or heavier to be fitted out with this device \cite{Mamm87}. \\
		
		It is worth noting that by using the 2A-h battery, the total system weight is 72.70 grams. This is significantly heavier than planned but is a good demonstration of the flexibility of design. This would allow for any animal around 1.5kg and heavier to be fitted out with this device. \\
		
		Both of these implementations would be able to be placed on most echidnas, but care would have to be taken to not place it on an echidna too light. It may not achieve the stated goals exactly as described but the weight is within the acceptable bounds for the primary application.
		\subsection{Enclosure}
		%TODO: IP679 Tests: \\
		%RESULTS: \\
		%-250g drop - 80cm max \\
		The enclosure had to be robust enough to survive the Australian outback. The most common method of defining case robustness is through the ingress protection (IP) and impact protection(IK) rating systems \cite{luma2014}. \\
		
		The chosen IK rating to test against was IK07 which rates the device to a 2 Joules impact. This should easily exceed any sort of impact an echidna can reasonably produce. This was tested by dropping a 250 gram weight at multiple heights. At a 400mm drop there was no visible damage (1J). At 800mm there was minor cosmetic damage but the enclosure remained entirely intact. The tests continued in 400mm intervals until a failure at 1600mm. The maximum height survivable was then 1200mm which means the enclosure could sustain an impact of atleast 3 Joules. \\
		%IK07: 2 Joules impact via 0.25kg at 800m \\
		
		The chosen IP rating to test against was IP67 which mandates no dust ingress whatsoever and no water ingress after submersion 1m below the water line for 30 minutes. Dust ingression is fairly difficult to test with the limited equipment that is available; a proper test requires the use of specialised tools to exactly quantify the incoming pressure and mass of uniformly sized dust. The closest equivalent that could be performed was using dust found around the UQ campus. Water ingression could be much more easily tested and the enclosure was found to have absolutely no water ingress. This also implies it would have had no dust ingress but that couldn't be tested entirely.

		\subsection{Operational Lifetime}
		
		The fundamental purpose of this project is to extend the operational lifetime from the 40 hours provided by the BEE-UTE board \cite{Freakley13} and turn that into something longer and much more palatable. \\
		
		Achieving very low current draws in this system has been quite difficult; the presence of the volatile memory chips has made minimising the sleep mode current challenging as there is always some minor current leakage in maintaining a transistor state. The document on reducing power consumption from Microchip \cite{PICPWR} details some of the commonly used tactics to reduce power consumption in embedded systems which were mostly employed. \\
		
		The input current was measured by measuring the difference in voltage across a 10 ohm 1\% resistor in series with the battery. The measurement was performed by the DSO-X 2002A Agilent oscilloscope and it is the source of all the quantitative data in this section and the waveforms shown in Figure \ref{fig:input}. \\
		
			\begin{figure}[H]
				\centering
				\includegraphics[width=14cm]{Figures/input.png}
				\caption{$\mu$Tracker Input Current \& Average DC Equivalent}
				\label{fig:input}
			\end{figure}	
			
		It can be seen in Figure \ref{fig:input} that the DC average input current is around 7.5mA. This is obviously significantly higher than expected however with a 1.2A-h battery this will result in a lifetime of 160 hours (~6.5 days) and the 2A-h battery will last around 270 hours (~11 days). \\
			
		\subsection{PCB} \label{sec:PCBERROR}
		The final PCB submitted was almost feature complete except for two small errors. Firstly the $\mu$SD card header footprint was reversed, and had to be bodged manually and the control pin for providing power to the $\mu$SD card was connected to an input only pin of the PIC24F. Fortunately this pin was right next to an unused output so a small solder bridge was all that was needed to correct it. \\
		
		Since submission these two issues have been fixed and are what appear in the final version of the supplied documents. This board is shown below in Figure \ref{fig:FINAL} with some connections and the UART output wires soldered on.
		
			\begin{figure}[H]
				\centering
				\includegraphics[width=4cm]{Figures/final.png}
				\caption{Final Board}
				\label{fig:FINAL}
			\end{figure}			
		
		The board supports all the planned features except for the $\mu$SD card due to an unfortunate late stage hardware failure and GPS module due to sourcing issues although there is an unpopulated footprint for the GPS module to occupy.		
 
		
	\section{Incomplete Work}
	Unfortunately, due to a combination of several issues, some features and sections of the project could either not be finished, or not be tested. Where otherwise mentioned, every entry into this section implicitly  should appear in Section \ref{sec:FUTURE}, "Future Work".
	
	\subsubsection{GPS Module}
		The GPS module could not be sourced in time for the final submission as it is only orderable directly from the manufacturer. Regardless of if it arrived in time the firmware would likely not be able to be implemented in time as GPS modules report very large amounts of data in odd intervals. \\
	\subsubsection{Proof of $\mu$SD Card} \label{sec:SDERROR}
		The $\mu$SD card could not be powered directly from the I/O ports of the PIC24F safely, instead a MOSFET switch was used to source power directly from the supply. Unfortunately when this was applied the transient power requirement was too high for the power supply and the voltage reduced significantly leading to a brownout event. This also damaged the $\mu$SD card, the memory modules and the MOSFET itself. \\
		
		This problem could be remedied by an series inductor with the $\mu$SD cards power supply or by using a larger capacitance on the power bus. Unfortunately this occured late in the project so there wasn't enough time to get another board fabricated or to test the efficacy of this proposed fix. \\
		
		Regardless of these issues all the $\mu$SD card firmware was written but is obviously not been debugged properly. The firmware uses FatFs and is designed to be capable of writing binary measurement data to a file. \\
		
	\subsubsection{Full Lifetime Measurement}
		A lifetime test of the device to see how long it truly lasts was unfortunately never performed. This would be a favorable experiment to conduct as then the transient power consumption of the $\mu$SD card could be better profiled and optimised against. The limiting factor in not being able to perform this experiment is obviously the lack of a functioning memory bus in light of the events described in section \ref{sec:SDERROR}. Another limiting factor would have been time as it there would not have been enough time to test it multiple times or fabricate extra boards and test them in parallel. \\
	
	\section{Specification Comparison}
	A direct comparison to the stated goals in section \ref{sec:spec} 'Product Specification' is useful to determine whether the project was successful or not and to what extent. This section will discuss the attributes of the final system and enclosure and compare them to the stated specifications in section \ref{sec:spec} and discuss what the impact of the success/failure of the metric has on the intended application of the project.\\
	
	%Adaptive data rate
	%Sensors	
	%Firmware
	\subsubsection{Firmware \& Sensors}
	Functionally the firmware is near complete; it has adaptive sampling rates, interacts with all the sensors implemented and was able to store data in the multilevel cache until the unfortunate hardware failure. All the sensors chosen and implemented would be able to adequately sense echidna movement, whether they are basking in the sun and accurately measure the temperature of the surrounding environment. \\
	

	%Max board size 40mm by 40mm
	%Max material cost 150AUD
	%PCB
	\subsubsection{PCB Size and Cost}
	The specified size and cost of the final system was to be less than 40mm by 40mm and cheaper than 150AUD. The final board is 20mm by 60mm which actually results in a smaller area by around 30\%. The cost is specified in Figure \ref{fig:BOM} to be less than 140AUD but that had a number of assumptions and doesn't take into account the cost of the PCB. Quantifying these costs can be quite difficult with the current volatility of the AUD and the volume of production unknown. In single quantities the PCB's cost 50AUD. Therefore by using a model without the GPS module the total real cost would be approximately 150\$ when taking into account the PCB, battery and $\mu$SD card, although these costs vary depending on application and volume. \\
	
	%Discuss previous paragraph + implications to use
	Fundamentally the cost isn't a critical issue for the project. The utility of such a product is relatively independent of price as it is the only device in the niche of non networked miniature sensors. The final size is better than the size specified however an exact maximum size for when the system becomes unsuitable is hard to quantify. Regardless the size is definitely small enough to accommodate being attached to echidnas. \\
	
	\subsubsection{Enclosure Ratings and System Weight}
	%Robustness			IP67 + IK07
	%Enclosure
	%Max weight 50g
	The enclosure has to be able to survive in the Australian outback to be fit for purpose. To quantify such an abstract metric the IP and IK ratings were employed. Despite that there are some factors of the experiment unable to be performed accurately (dust ingress) it seems likely that the used enclosure will hit IP67 and IK07 ratings for dust/water ingression and impact resistance respectively. These are incredibly important when such high energy density in the batteries is utilised; there should be no incident where the battery is exposed to water or animal interference from a safety standpoint. \\
	
	For the system to be used on an animal, the entire weight must be less than 5\% of the creatures total weight \cite{Mamm87}. The total weight of the system with a 1.2A-h battery is 56.85 grams while when outfitted with a 2A-h battery it is 72.70 grams. Both of these values are larger than the specified max weight of 50 grams but the purpose of the limit should be assessed before this is considered a failure to meet the spec. This particular metric was created in order to allow the device to be placed on an echidna. As discussed in section \ref{sec:echidna} an adult echidna weighs between 4.5-6.5kg. This would mean, even when outfitted with a 2A-h battery, the system is only 1.6\% of the weight of a 4.5kg echidna. This easily complies with the ethics regulations as stated in \cite{Mamm87} and would therefore be fit for purpose. This also means an even larger battery could be used. \\
	%Max weight
	
	%Operational lifetime 7 days
	\subsubsection{Operational Lifetime}
	The operational lifetime improvement was the motivating factor for this project as the BEE-UTE board would only last 40 hours in the field. Preliminary results shown in \ref{fig:input} suggest the average DC current draw would be 7.5mA leading to an 11 day lifetime with the 2A-h battery. Clearly there are significant improvements that can be made; the DC current draw should be able to be reduced until they are in the $\mu$A range. Regardless of this the device will operate for the specified lifetime of 7 and continue for around 4 days. Obviously the batteries will never have their full rated charge so the actual lifetime will be slightly less but not more than 10\% or so. \\
	%Battery
	
	\subsubsection{Functionality}
	In the final PCB there was a hardware failure that lead to the damage of several components on the memory bus. This is unfortunate and obviously stops the project from being in a state to actually achieve its core function of storing data. \\
	
	Despite this, the hardware presented meets all the other specifications that were planned and demonstrates that the core purpose, a longer lifetime, would be met by this project. A fully working product would only be a revision or two away. \\
	
	%Min storage space	1GB
	%Talk about impacts of missing SD card and why it doesn't matter
	\section{Future Work} \label{sec:FUTURE}
		Although the project achieves the primary purpose there are clearly a large number of areas where improvements or changes should be made:
		\begin{itemize}
			\item $\mu$SD card firmware should be tested
			\item Visualisation software expanded from scripts into GUI interfaces with support for input files rather than a UART stream
			\item Total current draw be lowered: this requires more investigation to determine the cause
			\item An external RTC should be used, with less drift and more smaller divisions in alarm settings.
			\item The MPU-9150 should be replaced by the Bosch BMI160
			\item Implement GPS firmware
			\item Design a future PCB to a specific case and select battery based upon that to minimise system volume
		\end{itemize}

\chapter{Conclusion}
	This project was ultimately created to improve the lifetime of the BEE-UTE board for the explicit purpose of tracking echidnas to better understand their physiology, in particular their thermoregulation. \\
	
	This was achieved by creating a custom system outfitted with sensors that was able to:
		\begin{itemize}
			\item Vary the sampling rate based on the current activity
			\item Use a multilevel cache of volatile and non volatile memories to reduce the frequency of writes to the $\mu$SD card
			\item Control the power supply of sensors and other IC's directly from the microcontrollers I/O ports
		\end{itemize}
	Despite some late stage hardware failures, all sections of the intended system were able to be demonstrated and the average DC current was low enough that the device will operate for atleast the specified lifetime of 1 week while inside an IP67 and IK07 rated enclosure. \\

\chapter{User Manual}

\begin{enumerate}
	\item Device Setup\\
	Using the device was designed to be very simple. Simply plug in the battery into the white terminal and turn the red switch into the on position. Upon startup the LED appearing in the top right of the board will flash several times in quick succession. If this light remains on it means there is no $\mu$SD card detected or there is a problem with it. During normal operation there is no other user feedback besides that given at turn on. \\
		
	\begin{figure}[H]
		\centering
		\includegraphics[width=9cm]{Figures/BATTERYIN.png}
		\caption{Device Powered On}
		\label{fig:BATTERYIN}
	\end{figure}
		
	\item Battery Charging
	%TODO: Specify what the lights do when you give up on improving the firmware
	Charging the battery is very simple, the microUSB hub is the charging port. Simply connect it to any compatible 500mA or 1A rated usb port and charging will begin immediately. \\
	
	\begin{figure}[H]
		\centering
		\includegraphics[width=9cm]{Figures/CHARGING.png}
		\caption{Device Powered On}
		\label{fig:CHARGING}
	\end{figure}
	
	\item Data Storage Format \\
		The data is simple binary data entered successively with no padding or checksums and is in little-endian format. The struct of the original data is shown in the following code snippet: \\
		\begin{lstlisting}
struct MEASUREMENT {
	//MS5637
	int32_t TEMPERATURE;
	int32_t PRESSURE;
	//Accelerometery
	int16_t X_ACC;
	int16_t Y_ACC;
	int16_t Z_ACC;
	//Light sensor
	uint16_t LALOG;
	//Time
	uint8_t day; //0-6 valid
	uint8_t hour; //lots of bad values could happen here
	uint8_t minute;
	uint8_t second;
	//TOTAL 160 bit
}
		\end{lstlisting}
		The following python code shows how to use the struct library to extract the values from a serial port into an array: \\
		\begin{lstlisting}
ser = serial.Serial('COM3', 142000, timeout=1)

FORMAT_STR = "<iihhhHBBBB"

x = ser.read()
result = struct.unpack(FORMAT_STR, x)
		\end{lstlisting}
		
		-Provide copy of struct \\
		-example python code to retrieve values\\
	\item Programming \\
		Programming of the device is done with the PICKit 3 and through Microchip's MPLAB software suite. Appropriate compilers and drivers should be downloaded directly from Microchip. \\
		
		To program the device, disconnect the battery and then plug in the PICKit 3 into the header directly below the logo ensuring that the pin 1 indicators of both the $\mu$Tracker and the PICKit align. \\ 
		
			\begin{figure}[H]
				\centering
				\includegraphics[width=9cm]{Figures/1.jpg}
				\includegraphics[width=9cm]{Figures/2.jpg}
				\includegraphics[width=9cm]{Figures/3.jpg}
				\caption{Connecting the Programmer}
				\label{fig:PROGRAMMING}
			\end{figure}
		
\end{enumerate}


\appendix

% Chapters after the \appendix command are lettered, not numbered.
% Setting apart the appendices in the table of contents is awkward:

\newpage
\addcontentsline{toc}{part}{Appendices}
\mbox{}
\newpage

% The \mbox{} command between two \newpage commands gives a blank page.
% In the contents, the ``Appendices'' heading is shown as being on this
% blank page, which is the page before the first appendix.  This stops the
% first appendix from be listed ABOVE the word ``Appendices'' in the
% table of contents.

% \include appendix chapters here.

\chapter{Schematics \& PCB Artwork}
		\includepdf[landscape=true, pages={3,1,2,4,5,6,7}]{schematics.pdf}
		
\chapter{Main Firmware Routine}
\lstinputlisting[firstline=149,lastline=388]{main.c}

\chapter{Submission Files}

\cleardoublepage


\begin{thebibliography}{99}
	\addcontentsline{toc}{chapter}{Bibliography}
	\bibitem{Coudert05}
	Yan Ropert-Coudert, Rory P. Wilson
	\emph{Trends and Perspectives in Animal-Attached Remote Sensing},
	Frontiers in Ecology and the Environment,
	Vol. 3, No. 8 (Oct. 2005), pp. 437-444
	
	\bibitem{Freakley13}
	Craig Freakley
	\emph{BEE-UTE Board System Reference Manual},
	University Of Queensland, June 2014
	
	\bibitem{Jurdak13}
	Raja Jurdak et al
	\emph{Camazotz: Multimodal Activity-Based GPS Sampling},
	Information Processing in Sensor Networks,
	ISBN: 978-1-4503-1959-1, pp. 67-68
	
	\bibitem{Bennett11}
	William P Bennett et al
	\emph{CraneTracker: A Multi-Modal Platform for Monitoring Migratory Birds on a Continental Scale},
	The ACM 17th Annual International Conference on Mobile Computing and Networking, 2011.
	
	\bibitem{Marshall07}
	Greg Marshal et al
	\emph{An Advanced Solid-state Animal-borne Video and Environmental Data-logging Device('CRITTERCAM') for Marine Research},
	Marine Technology Society Journal,
	Vol. 41, Issue 2 (June 2007), pp. 31-38
	
	\bibitem{Mamm87}
	The American Society of Mammologists (1987) \emph{Acceptable Field Methods of Mammalogy Preliminary guidelines prepared by the American Society of Mammalogists},
	Journal of Mammalogy Supp. Vol 68, No. 4. November p.13.
	
	\bibitem{Brice02}
	Peter H. Brice et al
	\emph{Heat tolerance of short-beaked echidnas (Tachyglossus aculeatus) in the field},
	University of Queensland, Jan 2002
	
	\bibitem{Ran12}
	Nathan, Ran et al
	\emph{Using tri-axial acceleration data to identify behavioral modes of free-ranging animals: general concepts and tools illustrated for griffon vultures.},
	The Journal of Experimental Biology (2012), 215(6), 986$-$996. doi:10.1242/jeb.058602
	
	\bibitem{Shepard08}
	Emily Shepard et al
	\emph{Identification of animal movement patterns using tri-axial accelerometry.},
	Endang Species Res 10:47-60 (2008)
	
	\bibitem{Lamprecht14}
	Marnie Lamprecht et al
	\emph{Multisite accelerometry for sleep and wake classification in children},
	Physiol. Meas. (2014) doi:10.1088/0967-3334/36/1/33
	
	\bibitem{Terrill13}
	Philip Terrill et al
	\emph{Measuring leg movements during sleep using accelerometry: Comparison with EMG and piezo-electric scored events},
	University of Queensland (July 2013) doi:10.1109/EMBC.2013.6611134
	
	\bibitem{Sandisk}
	Sandisk Corporation. (2007, Jun.) \\
	\emph{SanDisk SD Card Product Family - Product Manual.} [Online].\\ http://media.digikey.com/pdf/Data\%20Sheets/M-Systems\%20Inc\%20PDFs/SD\%20Card\%20Prod\%20Family\%20OEM\%20Manual.pdf
	
	\bibitem{TIUSB}
	Texas Instruments. (2015, Mar) \emph{bq2407x 1.5-A USB-Friendly Li-Ion Battery Charger and Power-Path Management IC} [Online],
	http://www.ti.com/lit/ds/symlink/bq24072.pdf
	
	\bibitem{TIBUCK}
	Texas Instruments. (2012, Mar) 
	\emph{High Efficiency Single Inductor Buck-Boost Converter with 1-A Switches} [Online],
	http://www.ti.com/lit/ds/symlink/tps63030.pdf
	
	\bibitem{PIC24}
	Microchip Technology Inc. (2011) 
	\emph{PIC24FJ128GA310 Family - Reference Manual} [Online],
	http://ww1.microchip.com/downloads/en/DeviceDoc/39996f.pdf
	
	\bibitem{PIC32}
	Microchip Technology Inc. (2008)
	\emph{PIC32MX Family - Reference Manual} [Online], http://ww1.microchip.com/downloads/en/DeviceDoc/PIC32MX\_Datasheet\_v2\_61143B.pdf
	
	\bibitem{TI2011}
	Texas Instruments. (2011)
	\emph{Linear and Switching Voltage Regulator Fundamental Part 1} [Online], http://www.ti.com/lit/an/snva558/snva558.pdf
	
	\bibitem{AVAGOLIGHT}
	Avago Technologies. (2007, Jan) 
	\emph{APDS-9005 Miniature Surface-Mount Ambient Light Photo Sensor} [Online],
	http://www.avagotech.com/docs/AV02-0080EN
	
	\bibitem{MEASPRESSURE}
	Measurement Specialties. (2013, Feb)
	\emph{MS5637-02BA03 Low Voltage Barometric Pressure Sensor}
	[Online],
	http://www.farnell.com/datasheets/1756129.pdf
	
	\bibitem{InvenMPU9150}
	InvenSense Inc. (2013, Sep)
	\emph{MPU-9150 Product Specification Revision 4.3} [Online],
	http://www.invensense.com/mems/gyro/documents/PS-MPU-9150A-00v4\_3.pdf
	
	\bibitem{MICRAM}
	Microchip Technology Inc. (2012)
	\emph{1 Mbit SPI Serial SRAM with Battery Backup and SDI Interface} [Online],
	http://ww1.microchip.com/downloads/en/DeviceDoc/25156A.pdf
	
	\bibitem{ubloxGPS}
	Swiss u-blox (2012)
	\emph{MAX-6 u-blox 6 GPS Modules - Data Sheet} [Online],
	https://www.u-blox.com/images/downloads/Product\_Docs/MAX-6\_DataSheet\_\%28GPS.G6-HW-10106\%29.pdf
	
	\bibitem{Carroll10}
	Aaron Carroll et al \emph{An Analysis of Power Consumption in a Smartphone}.
	USENIX Annual Technical Conference 2010
	
	\bibitem{NXPI2C}
	NXP Semiconductors (2014, Apr)
	\emph{I2C-bus specification and user manual} [Online],
	http://www.nxp.com/documents/user\_manual/UM10204.pdf
	
	\bibitem{bosch15}
	Bosch Sensortech (2015)
	\emph{Small, low power inertial measurement unit} [Online], https://ae-bst.resource.bosch.com/media/products/dokumente/bmi160/BST-BMI160-DS000-07.pdf
	
	\bibitem{icc}
	ICC Nexergy (2015)
	\emph{Comparison of Energy Densities for Various Battery Chemistries} [Online], http://www.iccnexergy.com/battery-systems/battery-energy-density-comparison/
	
	\bibitem{max17}
	Maxim Integrated (2012)
	\emph{Compact, Low-Cost 1S/2S Fuel Gauges} [Online], https://datasheets.maximintegrated.com/en/ds/MAX17040-MAX17041.pdf
	
	\bibitem{BSDstyle}
	OpenBSD (2015)
	\emph{style — Kernel source file style guide (KNF) - Manual Page} [Online], http://www.openbsd.org/cgi-bin/man.cgi/OpenBSD-current/man9/style.9?query=style\&sec=9
	
	\bibitem{PICPWR}
	Microchip (2009)
	\emph{PIC Microcontroller Low Power
		Tips ‘n Tricks} [Online], http://ww1.microchip.com/downloads/en/DeviceDoc/01146B\_chapter\%202.pdf
	
	\bibitem{Brattstrom73}
	Brattstrom, Bayard H. (1973)
	\emph{Social and Maintenance Behavior of the Echidna, Tachyglossus aculeatus}
	Journal of Mammalogy Vol. 54 No. 1 (Feb., 1973), pp. 50-70
	
	\bibitem{JL2013}
	JL (2013)
	\emph{PIC24 Tutorial} [Online], http://www.engscope.com/pic24-tutorial/
	
	\bibitem{luma2014}
	lumascape (2014)
	\emph{Ingress Protection Rating} [Online], http://www.lumascape.com/html/IP\_IK\_rating.htm
\end{thebibliography}

\end{document}